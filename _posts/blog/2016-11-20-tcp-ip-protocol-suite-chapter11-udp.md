---
layout: post
title: TCP/IP 协议族--用户数据报（UDP）
categories: 计算机网络
description: 计算机网络学习总结
keywords: 计算机网路,TCP/IP,UDP
---

　　最近在学习《TCP/IP SUITE》一书，作为学习总结记录于此，也作为以后自己复习的资料。
UDP位于运输层，是一种不可靠的无连接的运输层协议。它除了提供进程到进程的通信（注意：不是主机到主机的通信）外，就没有给IP服务添加任何东西。下图是UDP在TCP/IP协议族中的位置：
![](http://i.imgur.com/d6lAsGO.png)

## 1 进程到进程的通信
	
　　IP 协议负责主机到主机的通信，只能将报文交付给目的计算机。UDP 协议负责进程到进程的通信，可将报文交付给适当的进程。本地主机和远程主机是用IP地址来定义的，而要定义进程，需要使用到**端口号** 。端口号分为三类：

   1. 熟知端口，0~1023
   2. 注册端口
   3. 动态端口

　　一个IP地址与一个端口号合起来就叫做**套接字地址（socket address）** 。客户套接字地址唯一的定义了客户进程，而服务器套接字地址唯一的定义了服务器进程。

## 2 用户数据报（User DataGram）

　　UDP叫做用户数据报，有8个字节的固定首部，它的格式如下：
![](http://i.imgur.com/qtY5ZjC.png)

## 3 检验和

　　UDP检验和的计算与IP和ICMP检验和的计算不同。UDP中的检验和包括三部分：伪首部，UDP首部以及从应用层来的数据。伪首部是IP分组的首部的一部分。
![](http://i.imgur.com/gErV1k2.png)
　　检验和的计算步骤：

1. 将伪首部添加到UDP用户数据报上
2. 把检验和字段填入零
3. 把所有位划分为16位（2字节）的字
4. 若字节总数不是偶数，则增加一个字节的填充（全是0）。填充只是为了计算检验和，计算完毕后把它丢弃
5. 把所有16位的字使用反码算术运算相加
6. 把得到的结果取反码，它是一个16位的数，把这个书插入到检验和字段
7. 把伪首部和任何增加的填充丢掉
8. 把UDP用户数据报交付给IP软件进行封装

　　下图是一个简单UDP用户数据报检验和的计算：
![UDP-CheckSum](http://i.imgur.com/agF6Ip4.png)

## 4 UDP的操作

### 4.1 无连接的服务

　　UDP提供无连接的服务，这就表示发送出的每个用户数据报都是独立的数据报。每个用户数据报可以走不同的路径。

### 4.2 流量控制和差错控制

　　UDP没有流量控制，因而也没有窗口机制。当到来的报文太多时，接收端可能会溢出。除了检验和之外，UDP也没有别的差错控制机制。这就表示发送端并不知道报文是丢失了还是重复的提交了。当接收端使用校验和并检测出差错时，就直接将用户数据报丢掉。缺少流量控制和差错控制就表示：使用UDP的进程必须要提供这些机制。

### 4.3 封装和拆装

　　要从一个进程把报文发送到另外一个进程，UDP协议就要把报文进行封装和拆装。如下图：
![](http://i.imgur.com/3Xcevdw.png)

### 4.4 复用和分用

![复用和分用](http://i.imgur.com/i7Gerpw.png)

#### 4.4.1 复用
　　
在发送端，可能有多个进程需要发送用户数据报。但是，只有一个UDP。此时需要复用，UDP从不同的进程接受报文，这些进程是由指派给他们的端口号来区分的。在加上首部之后，UDP就把用户数据报送往IP。

#### 4.4.2 分用
　　
在接收端，也是只有一个UDP。但是，有多个进程可能接受用户数据报，这时就需要分用。UDP从IP接收用户数据报，经过差错检查后丢掉首部。UDP根据端口号把每个报文交付给适当的进程。

## 5 UDP的使用

　　UDP协议的某些用途：

1. UDP适用于这样的进程，它需要简单的请求-响应通信，而较少的考虑流量控制和差错控制。对于需要传送成块数据的进程（例如：FTP），则不适用。
2. UDP适用于具有内部流量控制和差错控制机制的进程。
3. 对于多播和广播，UDP是一个比较好的协议。
4. UDP可用于管理进程，如SNMP。

## 6 UDP软件包

　　UDP的设计如下图，UDP软件包包含5部分：一个控制块表，若干个输入队列，一个控制块模块，一个输入模块和一个输出模块。
![UDP软件包](http://i.imgur.com/RP0dp0c.png)

### 6.1 控制块表

　　UDP用控制块表来记录打开的端口。

### 6.2 输入队列

　　使用一组输入队列，每一个对应于一个进程。

### 6.3 控制块模块

　　控制块模块负责管理控制块表。

### 6.4 输入模块

　　输入模块从IP接收用户数据报。
![输出模块](http://i.imgur.com/YwFQckh.png)

### 6.5 输出模块

　　输出模块负责创建和发送用户数据报。
