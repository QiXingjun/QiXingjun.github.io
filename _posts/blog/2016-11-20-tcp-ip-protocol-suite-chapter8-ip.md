---
layout: post
title: TCP/IP 协议族--网际协议（IP）
categories: 计算机网络
description: 计算机网络学习总结
keywords: 计算机网路,TCP/IP
---

　　最近在学习《TCP/IP SUITE》一书，作为学习总结记录于此，也作为以后自己复习的资料。
IP位于网络层，是一种不可靠的无连接的数据报协议，只提供尽最大努力的服务，而尽最大努力的意思是不提供差错检查和跟踪。当可靠性很重要时，IP可以和TCP配合使用。现实生活中，与IP类似的是邮政局，邮政局尽最大努力的交付邮件，但是并不保证邮件成功送达。


## 1 数据报
	
　　在IP层的分组叫做数据报，数据报是可变长度分组，由两部分组成：首部和数据。
![IP数据报](http://i.imgur.com/AVeSraa.png)
　　其中，**VER** 定义了IP协议的版本，现在大多是4。**HLEN** 是首部长度，以4字节为单位。因为首部长度是可变的（在20~60字节之间），所以这个字段的值在5~15之间（当没有选项时，字段为5，当选项字段为最大值时，字段为15）。**DS**叫做区分服务。**Total length**s是总长度。这是一个16位的字段，定义了数据报的总长度（首部长度+数据长度）。

## 2 分片

### 2.1 最大传输单元（Maximum Transfer Unit,简称MTU）
　　
当数据报分装成帧的时候，数据报的长度必须小于这个数据字段的最大长度，对于不同的物理网络协议，MTU的值是不同的。
![MTU](http://i.imgur.com/8WWj6iM.png)
当数据报的长度大于MTU时，就要进行**分片**，其中分片在运输层进行，而数据报的重装只能在目的主机进行。
### 2.2 与分片有关的字段

　　**标识（identification）** ，16位字段，当数据报离开源主机的时候，这个标识与源IP地址必须唯一的定义这个数据报。为了确保唯一性，IP协议使用一个计数器来标志数据报。当数据报被分片时，标识字段的值就复制到所有的分片中。这个标识号在重装数据的时候很有用，终点知道所有具有相同标识的分片必须组装成一个数据报。

　　**标志（flags）** ，3位字段，第一位保留为以后使用。第二位是**不分片（do not fragment）** 位。若这个位的值是1，机器就不能把该数据报进行分片，若这个位的值是0，就需要分片。第三位是**还有分片（more fragment）**位。若这个位的值是1，则表示这个数据报不是最后的分片，后面应该还有更多的分片，若这个位的值是0，则表示这已经是最后的分片了或者是唯一的分片了。

　　**分片偏移（fragmentation offset）** ，13位字段，表示这个分片在整个数据报中的相对位置，以8字节为单位。假如：某个分片携带的数据是字节1400~2799，则对于这个数据报，偏移值是1400/8=175。

## 3 检验和

　　大多数的TCP/IP协议族采用的差错检测的方法是检验和。在发送端先计算检验和，并把得到结果与分组一起发出去。接收端对检验和在内的整个分组重复进行相同的计算，若得到的结果正确，则接受这个分组，否则把它丢弃。

　　如何产生检验和呢？
    
   1. 把分组划分成k段，每段都是n长，其中ｎ通常为16
   2. 用反码算术运算把所有这些段相加
   3. 把最终结果取反码就得出检验和
   
　　在接收端把收到的分组划分成ｋ段，并把所有的结果相加，把得到的和取反码。若结果是０，则接受这个分组，否则拒绝这个分组。**需要注意的是：IP分组的检验和只在首部进行，而不再数据部分进行。** 理由有两点：

   1. 所有将数据封装在IP数据报中的高层协议，都有覆盖整个分组的校验和，因此IP数据报的校验和就不必再次检验所封装的数据部分。
   2. 每次经过一个路由器，IP数据报的首部就要改变一次，但是数据部分不变，因此检验和只对发生变化的部分进行检验。若检验包含了数据部分，则会发生很多的重复检验。 