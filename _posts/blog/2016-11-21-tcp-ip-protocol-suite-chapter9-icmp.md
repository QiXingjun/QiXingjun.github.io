---
layout: post
title: TCP/IP 协议族--网际控制报文协议（ICMP）
categories: 计算机网络
description: 计算机网络学习总结
keywords: 计算机网路,TCP/IP,ICMP
---

　　最近在学习《TCP/IP SUITE》一书，作为学习总结记录于此，也作为以后自己复习的资料。
ICMP的全称是Internet Control Message Protocol。ICMP是配合IP协议进行使用的，ICMP弥补了IP协议缺少差错控制和缺少管理查询的缺陷。ICMP在网络层中的位置如下：
![ICMP在网络层的位置](http://i.imgur.com/oBxyQDw.png)
　　ICMP报文首先要封装成IP数据报，然后再传送给下一层，在IP数据报中的协议字段是1就表示其IP数据是ICMP报文。
![ICMP协议的封装](http://i.imgur.com/w6ol1lA.png)

## 1 报文类型

　　ICMP报文可以分为两大类：**差错报告报文和查询报文** 。差错报告报文报告路由器或主机（目的端）在处理IP数据报时可能遇到的一些问题。查询报文是成对出现的，它帮助主机或网管人员从路由器或另一主机获得特定的信息。
![ICMP报文](http://i.imgur.com/XT5NrBg.png)

## 2 差错报告

　　ICMP不能纠正差错，它只能报告差错。ICMP使用源IP地址把差错报文发送给原始的数据源。关于ICMP差错报文，需要注意以下几点：

- 对于携带ICMP差错报文的数据报，不再产生ICMP差错报文。
- 对于分片的数据报，如果不是第一个分片，则不产生ICMP差错报文。
- 对于具有多播地址的数据报，不产生ICMP差错报文。
- 对于具有特殊地址（如127.0.0.0或者0.0.0.0）的数据报，不产生ICMP差错报文。

　　所有的差错报文都包括数据部分，而这数据部分包括原始数据报的首部加上数据报的前8个字节的数据。加上原始数据报中的首部的目的是：为了向接收差错报文的原始信源给出关于数据报本身的信息。而包括数据的前8个字节是因为这前8个字节提供了关于端口号（UDP和TCP）和序号（TCP）的信息。
![差错报文的数据字段内容](http://i.imgur.com/LKTB3ki.png)

### 2.1 终点不可达

　　当路由器不能够给数据报找到路由器或者主机不能交付数据报时，就丢弃这个数据报，然后这个路由器或者主机就向发出这个数据报的源主机发回**终点不可达报文**　。

### 2.２源点抑制

　　在IP协议中，由于缺乏流量控制，因此会产生拥塞的问题。ICMP的**源点抑制报文** 就是为了解决IP中缺乏流量控制而设计的。当路由器或者主机因为拥塞而丢弃数据报时，它就向数据报的发送端发送源点抑制报文。对于每个由于拥塞而被丢弃的数据报，都应该发送源点抑制报文。这个报文有两个目的：一，它通知源点，数据报已经被丢弃。二，它警告源点，在路径中的某处出现了拥塞，因而必须放慢发送过程。

### 2.3 超时

　　当收到数据报的路由器在发现生存时间的值为0时，就丢弃这个数据报。当丢弃这样的数据报的时候，就要由路由器向源点发送**超时报文。** 当组成报文的所有分片未能在某一时限内到达目的主机时，也要产生超时报文。

### 2.1 改变路由

　　主机在开始工作的时候只有很小的路由表，这个路由表主键增大和更新，完成这个工作的其汇总给一个工具就是改变路由报文。
![改变路由](http://i.imgur.com/0P3kyDj.png)
　　如上图所示：主机A打算向主机B发送数据报。路由器R2显然是最有效的路由选择，但是主机A没有选择路由器R2。数据报被发送到路由器R1而不是R2。R1在查找路由表之后发现分组应该通过R2。它把分组发送到R2，并同时向主机A发送**改变路由报文** 。主机A的路由表就被更新了。改变路由报文是由路由器向同一个本地网络上的主机发送的。

## 3 查询

　　除了差错报告外，ICMP还能对某些网络问题进行诊断。这是通过使用由4对不同报文组成的查询报文来完成的。![查询报文](http://i.imgur.com/sCEzAfU.png)

### 3.1 回送请求和回答

　　主机或者路由器可以发送回送请求报文给另外一个主机或者路由器。收到回送请求的主机或者路由器产生回送回答报文，并将其返回给原来的发送者。回送请求和回送回答报文可以用来确定是否在IP这级能够通信。用回送请求和回送回答报文可以测试某个主机的可达性。

### 3.2 回送请求和回答

　　两个主机或者路由器可以使用时间戳请求和时间戳回答报文来确定IP数据报在这两个机器之间来往所需的往返时间。它也可以用作两个机器中的时钟的同步。源点产生时间戳请求报文。终点产生时间戳回答报文。其中，接收时间戳字段是收到这个请求时的时间。终点在回答报文离开的时候，产生发送时间戳。

### 3.3 回送请求和回答

　　主机可能知道自己的IP，但是它可能不知道相应的掩码。要得到掩码，主机应当向局域网上的路由器发送**地址掩码请求报文。** 若主机知道这个路由器的地址，它就把请求直接发送给该路由器。若主机不知道，则广播这个报文。路由器收到地址掩码请求报文，就以**地址掩码回答报文** 进行相应。

## 4 拍错工具

　　使用ICMP进行排错的工具：**ping和traceroute** 。

- ping：测试某个主机的可达性。
- traceroute：跟踪一个分组从源点到终点的路径。

